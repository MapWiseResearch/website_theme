name: Deploy WordPress Theme via SSM (artifact, public)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Verify AWS identity
        run: aws sts get-caller-identity

      - name: Deploy theme to EC2 (zip artifact)
        env:
          EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
        run: |
          CMD_ID=$(aws ssm send-command \
            --instance-ids "$EC2_INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy MapWise theme (public artifact zip)" \
            --query "Command.CommandId" \
            --output text \
            --parameters commands='[
              "set -euxo pipefail",
              "THEME_DIR=/var/www/mapwisepolitics/wp-content/themes/mapwise",
              "WORKDIR=/tmp/mapwise_theme_deploy",
              "ZIP_URL=https://github.com/MapWiseResearch/website_theme/archive/refs/heads/main.zip",
              "",
              "rm -rf \"$WORKDIR\" && mkdir -p \"$WORKDIR\"",
              "cd \"$WORKDIR\"",
              "curl -L -o theme.zip \"$ZIP_URL\"",
              "rm -rf extracted && mkdir extracted",
              "unzip -q theme.zip -d extracted",
              "SRC_DIR=$(find extracted -maxdepth 1 -type d -name \"website_theme-*\" | head -n 1)",
              "test -n \"$SRC_DIR\"",
              "test -f \"$SRC_DIR/style.css\"",
              "test -f \"$SRC_DIR/functions.php\"",
              "",
              "command -v rsync >/dev/null 2>&1 || (apt-get update -y && apt-get install -y rsync)",
              "mkdir -p \"$THEME_DIR\"",
              "rsync -a --delete \"$SRC_DIR/\" \"$THEME_DIR/\"",
              "chown -R www-data:www-data \"$THEME_DIR\"",
              "find \"$THEME_DIR\" -type d -exec chmod 755 {} \\;",
              "find \"$THEME_DIR\" -type f -exec chmod 644 {} \\;",
              "",
              "echo DEPLOYED_AT=$(date -Is)",
              "head -n 15 \"$THEME_DIR/style.css\"",
              "stat \"$THEME_DIR/style.css\" | sed -n \"1,8p\""
            ]')

          aws ssm wait command-executed \
            --command-id "$CMD_ID" \
            --instance-id "$EC2_INSTANCE_ID"

          aws ssm get-command-invocation \
            --command-id "$CMD_ID" \
            --instance-id "$EC2_INSTANCE_ID" \
            --query "{Status:Status,Stdout:StandardOutputContent,Stderr:StandardErrorContent}" \
            --output json
